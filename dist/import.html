<style>
textarea::-webkit-scrollbar {
  width: 8px;
}

textarea::-webkit-scrollbar-track {
  background: transparent;
}

textarea::-webkit-scrollbar-thumb {
  background-color: gray;
  border-radius: 8px;
  border: 2px solid transparent;
}

textarea::-webkit-scrollbar-thumb:hover {
  background-color: lightgray;
  cursor: pointer;
}

textarea::-webkit-scrollbar-thumb:active {
  background-color: lightgray;
}

textarea::-webkit-scrollbar-thumb:vertical {
  border-radius: 8px;
}

textarea::-webkit-scrollbar-thumb:horizontal {
  border-radius: 8px;
}

textarea::-webkit-scrollbar-corner {
  background: transparent;
}

textarea::-webkit-resizer {
  background: transparent;
}

textarea::-webkit-scrollbar-button {
  display: none;
}

textarea::-webkit-scrollbar-button:end:increment {
  display: none;
}
.tablepreview-wrapper::-webkit-scrollbar {
  width: 8px;
}

.tablepreview-wrapper::-webkit-scrollbar-track {
  background: transparent;
}

.tablepreview-wrapper::-webkit-scrollbar-thumb {
  background-color: gray;
  border-radius: 8px;
  border: 2px solid transparent;
}

.tablepreview-wrapper::-webkit-scrollbar-thumb:hover {
  background-color: lightgray;
  cursor: pointer;
}

.tablepreview-wrapper::-webkit-scrollbar-thumb:active {
  background-color: lightgray;
}

.tablepreview-wrapper::-webkit-scrollbar-thumb:vertical {
  border-radius: 8px;
}

.tablepreview-wrapper::-webkit-scrollbar-thumb:horizontal {
  border-radius: 8px;
}

.tablepreview-wrapper::-webkit-scrollbar-corner {
  background: transparent;
}

.tablepreview-wrapper::-webkit-resizer {
  background: transparent;
}

.tablepreview-wrapper::-webkit-scrollbar-button {
  display: none;
}

.tablepreview-wrapper::-webkit-scrollbar-button:end:increment {
  display: none;
}

.tablepreview-wrapper {
  flex: 1;
  justify-self: stretch;
  align-self: stretch;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-start;
  text-align: left;
  border-radius: 8px;
  overflow: auto;
  padding: 0px;
  background-color: rgba(0, 0, 0, 0.10);
  border: gray 1px solid;
}

.tablepreview-wrapper table {
  position: absolute;
  top: 0;
  left: 0;
}

.tablepreview-wrapper.hidden {
  display: none;
}

table {
  border-collapse: collapse;
  margin: 0;
  font-size: 0.9em;
  font-family: sans-serif;
  min-width: 100%;
}

table thead tr {
  color: inherit;
  text-align: left;
  background-color: rgba(0, 0, 0, 0.35);
}

table thead {
  background-color: rgba(0, 0, 0, 0.35);
  position: sticky;
  top: 0;
  outline: 1px solid gray;
}

table th,
table td {
  padding: 12px 15px;
}

table tbody tr {
  border-bottom: 1px solid gray;
}

table tbody tr:nth-of-type(even) {
  background-color: rgba(0, 0, 0, 0.10);
}

table tbody tr:last-of-type {
  border-bottom-style: none;
}

table tbody td.changed {
  background-color: rgba(0, 255, 0, 0.2);
}	</style>
<style>
body {
  margin: 0;
  padding: 0;
  font-family: "Roboto", sans-serif;
  font-size: 16px;
  font-weight: 400;
  line-height: 1.5;
  color: white;
  text-align: left;
  padding: 1rem;
}

.body-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  gap: 1rem;
  height: 100%;
  width: 100%;
}

.toggle-wrapper {
  border-radius: 8px;
  position: relative;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  text-align: center;
  width: 100%;
  background-color: lightgray;
  height: 32px;
  font-weight: 500;
}

.segment-wrapper {
  z-index: 2;
  width: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  line-height: 0px;
  cursor: pointer;
}

.segment-wrapper label {
  height: 100%;
  width: 100%;
  user-select: none;
  cursor: pointer;
}

.toggle-wrapper[data-selected="textarea"] .segment-wrapper.textarea {
  color: black;
}

.toggle-wrapper[data-selected="tablepreview"] .segment-wrapper.tablepreview {
  color: black;
}

.toggle-wrapper[data-selected="textarea"]
  .segment-wrapper.textarea[data-valid="false"]
  label {
  opacity: 0.1;
}

.toggle-wrapper[data-selected="tablepreview"]
  .segment-wrapper.tablepreview[data-valid="false"]
  label {
  opacity: 0.1;
}

.toggle-wrapper[data-selected] .segment-wrapper[data-valid] label {
  transition-delay: 0.2s;
  transition: all 0.3s ease-in-out;
}

.selector-indicator {
  background-color: red;
  border-radius: inherit;
  width: 50%;
  height: 100%;
  position: absolute;
  top: 0;
  z-index: 1;
  transition: all 0.3s ease-in-out;
}

.toggle-wrapper[data-selected="tablepreview"] .selector-indicator {
  right: 0px;
  left: 50%;
}

.toggle-wrapper[data-selected="textarea"] .selector-indicator {
  left: 0px;
  right: 50%;
}

.segment-wrapper input {
  display: none;
}

.textarea-wrapper {
  width: 100%;
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-start;
  text-align: left;
  position: relative;
}

.textarea-wrapper.hidden {
  display: none;
}

.textarea-wrapper .instructions {
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  position: absolute;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 2rem;
  gap: 2rem;
  opacity: 100%;
  transition: all 0.5s ease-in-out;
  background-color: rgba(0, 0, 0, 0.5);
  border-radius: 8px;
}

.textarea-wrapper .instructions p {
  opacity: 25%;
}

.textarea-wrapper .instructions.hidden {
  opacity: 0%;
}

textarea {
  width: 100%;
  height: 100%;
  border-radius: 8px;
  resize: none;
  border: gray 1px solid;
  outline: none;
  background-color: transparent;
  color: white;
  font-family: "Roboto", sans-serif;
  font-size: 16px;
  font-weight: 400;
  line-height: 1.5;
  text-align: left;
  padding: 1rem;
}

#notice {
  pointer-events: none;
  text-align: left;
  padding: 1rem;
  transition: all 0.5s ease-in-out;
  border-radius: 8px;
  place-self: stretch;
}

#notice p {
  margin: 0;
  padding: 0;
  font-family: "Roboto", sans-serif;
  font-size: 14px;
  font-weight: 400;
  line-height: 1.5;
  text-align: left;
}

.error-box {
  background-color: #ffe5e5;
  border: #a35f5f 1px solid;
}

.info-box {
  background-color: #e5e5ff;
  border: #5f5fa3 1px solid;
}

#notice.hidden {
  display: none;
}

.error-box p {
  color: #a35f5f;
}

.info-box p {
  color: #5f5fa3;
}

form {
  display: contents;
}

/* the two CTA buttons should take the whole width. if one button is present, it should be full-width */

.cta-wrapper {
  width: 100%;
  display: flex;
  gap: 1rem;
  flex-direction: row;
  align-items: center;
  justify-content: stretch;
  box-sizing: border-box;
}

.cta-wrapper button {
  border: 1px solid rgba(255, 255, 255, 0.1);
  outline: none;
  background-color: transparent;
  color: white;
  font-family: "Roboto", sans-serif;
  font-size: 16px;
  font-weight: 400;
  line-height: 1.5;
  text-align: center;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s ease-in-out;
  text-overflow: ellipsis;
  flex-grow: 1;
}

.cta-wrapper button:hover {
  color: lightgray;
  background-color: rgba(255, 255, 255, 0.1);
}
	</style>

<div class="body-wrapper">
  <div class="toggle-wrapper" data-selected="textarea">
    <div class="segment-wrapper textarea" data-valid="true">
      <input type="radio" name="view-type" id="textarea" value="textarea" />
      <label for="textarea">Paste table</label>
    </div>
    <div class="segment-wrapper tablepreview" data-valid="true">
      <input
        type="radio"
        name="view-type"
        id="tablepreview"
        value="tablepreview"
      />
      <label for="tablepreview">Table preview</label>
    </div>
    <div class="selector-indicator"></div>
  </div>
  <form>
    <div class="textarea-wrapper">
      <div class="instructions">
        <p>Paste your variables here</p>
      </div>
      <textarea required></textarea>
    </div>
    <div class="tablepreview-wrapper hidden"></div>
    <div id="notice" class="error-box hidden">
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Recusandae
        quam earum animi, iste, dolor repudiandae dolore molestiae ut eius
        facere natus. Quae, fugit eligendi! Architecto, blanditiis! Provident
        iusto dolorem debitis.
      </p>
    </div>
    <div class="cta-wrapper">
      <button id="JSON" type="submit" class="hidden">Import JSON</button>
      <button id="CSV" type="submit">Update Variables from CSV</button>
    </div>
  </form>
</div>

<!-- <form>
  <textarea required placeholder="Variables"></textarea>
  <button id="JSON" type="submit" class="hidden">Import JSON</button>
  <button id="CSV" type="submit">Update Variables from CSV</button>
</form> -->

<script>
  // attach a listener to every input of type radio with the name "view-type". When the value changes, update the data-selected attribute of the .toggle-wrapper element to the value of the selected radio button, only if the nearest parent with the class "segment-wrapper" has a data-valid attribute of "true". Otherwise alert the user that the input is invalid.
  document
    .querySelectorAll("input[type=radio][name=view-type]")
    .forEach((radio) => {
      radio.addEventListener("change", (e) => {
        let segmentWrapper = e.target.closest(".segment-wrapper");
        if (segmentWrapper.dataset.valid === "true") {
          document.querySelector(".toggle-wrapper").dataset.selected =
            e.target.value;
          // if the value is table-preview, hide the textarea-wrapper element and show the table-preview element. Otherwise, hide the table-preview element and show the textarea-wrapper element.
          if (e.target.value === "tablepreview") {
            document.querySelector(".textarea-wrapper").classList.add("hidden");
            document
              .querySelector(".tablepreview-wrapper")
              .classList.remove("hidden");
            let hasChanges = document
              .querySelector("#notice")
              .getAttribute("changes");
            if (hasChanges === "true") {
              document.querySelector("#notice").classList.remove("hidden");
            } else {
              document.querySelector("#notice").classList.add("hidden");
            }
          } else {
            document
              .querySelector(".textarea-wrapper")
              .classList.remove("hidden");
            document
              .querySelector(".tablepreview-wrapper")
              .classList.add("hidden");
            validateCSV(
              document.querySelector(".textarea-wrapper textarea").value
            );
          }
        } else {
          alert("Invalid input");
        }
      });
    });
  //
  // when the textarea element inside of the .textarea-wrapper element is in focus, add the class .hidden to the .instructions element. When the textarea element is blurred and has no content inside of it, remove the class .hidden from the .instructions element.
  document
    .querySelector(".textarea-wrapper textarea")
    .addEventListener("focus", (e) => {
      document
        .querySelector(".textarea-wrapper .instructions")
        .classList.add("hidden");
    });
  document
    .querySelector(".textarea-wrapper textarea")
    .addEventListener("blur", (e) => {
      if (e.target.value.trim() === "") {
        document
          .querySelector(".textarea-wrapper .instructions")
          .classList.remove("hidden");
      }
    });
  // when the value of the textarea element inside of the .textarea-wrapper element changes, test if it's a comma delimited csv, tab delimited csv, or neither.If it's a valid csv, add the class .hidden to the #notice element, call the "CSVtoTable(delimiter)" function, and remove the "disabled" attribute from the #CSV button. If it's not a valid csv, remove the class .hidden from the #notice element and add the attribute "disabled" to the #CSV button.
  document
    .querySelector(".textarea-wrapper textarea")
    .addEventListener("input", (e) => {
      console.log("pasted");
      let body = e.target.value.trim();
      validateCSV(body);
    });
  //
  function validateCSV(body) {
    let validCSVcomma = isValidCSV(body, "comma");
    let validCSVtab = isValidCSV(body, "tab");
    let tableElement = document.querySelector(".tablepreview-wrapper");
    if (validCSVcomma) {
      console.log("valid comma csv");
      document.querySelector("#notice").classList.add("hidden");
      document.querySelector("#notice").classList.remove("error-box");
      document.querySelector("#CSV").removeAttribute("disabled");
      document.querySelector("#tablepreview").removeAttribute("disabled");
      CSVtoTable(body, tableElement, "comma");
    } else if (validCSVtab) {
      console.log("valid tab csv");
      document.querySelector("#notice").classList.add("hidden");
      document.querySelector("#notice").classList.remove("error-box");
      document.querySelector("#CSV").removeAttribute("disabled");
      document.querySelector("#tablepreview").removeAttribute("disabled");
      CSVtoTable(body, tableElement, "tab");
    }
    // not valid csv
    if (!validCSVcomma && !validCSVtab) {
      invalidCSV(body);
    }
    // if body is empty, disable the #CSV button and hide the error box
    if (body === "") {
      document.querySelector("#CSV").setAttribute("disabled", "");
      document.querySelector("#notice").classList.add("hidden");
      document.querySelector("#notice").classList.remove("error-box");
    }
  }
  //
  function isValidCSV(body, delimiter) {
    let newLineRegex = /\n(?=V)/;
    let delimiterRegex = delimiter === "comma" ? /,/ : /\t/;
    let rows = body.split(newLineRegex);
    let rowLength = rows[0].split(delimiterRegex).length;
    let isValid = true;
    rows.forEach((row) => {
      if (row.split(delimiterRegex).length !== rowLength) {
        isValid = false;
      }
    });
    return isValid;
  }
  //
  function invalidCSV(body) {
    console.log("invalid csv");
    document.querySelector("#notice").classList.remove("hidden");
    document.querySelector("#notice").classList.remove("info-box");
    document.querySelector("#notice").classList.add("error-box");
    document.querySelector("#notice p").textContent =
      "Invalid CSV. Please check your formatting.";
    document.querySelector("#CSV").setAttribute("disabled", "");
    document.querySelector("#tablepreview").setAttribute("disabled", "");
  }
  //
  function CSVtoTable(csv, tableElement, delimiter) {
    let newLineRegex = /\n(?=V)/;
    let delimiterRegex = delimiter === "comma" ? /,/ : /\t/;
    let rows = csv.split(newLineRegex);
    let table = document.createElement("table");
    let tableBody = document.createElement("tbody");
    let tableHead = document.createElement("thead");
    let headerRow = document.createElement("tr");
    let headerCells = rows[0].split(delimiterRegex);
    headerCells.shift();
    headerCells.forEach((cell) => {
      let headerCell = document.createElement("th");
      headerCell.textContent = cell;
      headerRow.appendChild(headerCell);
    });
    tableHead.appendChild(headerRow);
    table.appendChild(tableHead);
    rows.shift();
    rows.forEach((row) => {
      let tableRow = document.createElement("tr");
      let cells = row.split(delimiterRegex);
      let id = cells[0];
      let variableID = id.split("__")[0].replace("VariableID:", "");
      let modeId = id.split("__")[1];
      cells.shift();
      for (let i = 0; i < cells.length; i++) {
        let identifier = "";
        if (i === 0) {
          identifier = variableID;
        } else if (i === 1) {
          identifier = modeId;
        }
        let tableCell = document.createElement("td");
        // tableCell.textContent = cells[i] + "" + identifier;
        tableCell.textContent = cells[i];
        if (i > 1) {
          tableCell.classList.add("value");
          tableCell.setAttribute("data-variableid", variableID);
          tableCell.setAttribute("data-modeid", modeId);
        }
        tableRow.appendChild(tableCell);
      }
      tableBody.appendChild(tableRow);
    });
    table.appendChild(tableBody);
    tableElement.innerHTML = "";
    tableElement.appendChild(table);
    findChanges();
  }
  //
  function findChanges() {
    let values = document.querySelectorAll("table .value");
    let body = [];
    values.forEach((value) => {
      let variableID = value.getAttribute("data-variableid");
      let modeId = value.getAttribute("data-modeid");
      let newValue = value.textContent;
      let variable = {
        variableID: "VariableID:" + variableID,
        modeId: modeId,
        value: newValue,
      };
      body.push(variable);
    });
    parent.postMessage(
      {
        pluginMessage: {
          body: body,
          type: "TO_COMPARE",
        },
      },
      "*"
    );
  }
  function displayChanges(json) {
    let changes = JSON.parse(json);
    let table = document.querySelector("table");
    let changedCount = 0;
    changes.forEach((change) => {
      let variableID = change.variableID;
      let modeId = change.modeId;
      let cell = table.querySelector(
        `.value[data-variableid="${variableID}"][data-modeid="${modeId}"]`
      );
      // any hits for cell?
      if (cell) {
        changedCount++;
        cell.classList.add("changed");
      }
    });
    if (changedCount === 0) {
      document.querySelector("#notice").setAttribute("changes", "false");
      document.querySelector("#notice").classList.remove("info-box");
    } else {
      document.querySelector("#notice").setAttribute("changes", "true");
      document.querySelector("#notice").classList.add("info-box");
      document.querySelector(
        "#notice p"
      ).textContent = `${changedCount} variables have been updated. They're highlighted here for you to check!`;
    }
  }
  // when a message is received from the plugin code
  onmessage = (event) => {
    const message = event.data.pluginMessage;
    // if the message is of type "COMPARE_RESULT"
    if (message.type === "COMPARE_RESULT") {
      console.log("COMPARE_RESULT");
      displayChanges(message.result);
    }
  };
  //
  document.querySelector("form").addEventListener("submit", (e) => {
    // if the button that was pressed has the ID of "json"
    let submitter = e.submitter.id;
    const body = document.querySelector("textarea").value.trim();
    e.preventDefault();
    if (submitter === "JSON") {
      if (isValidJSON(body)) {
        parent.postMessage(
          {
            pluginMessage: {
              body,
              type: "IMPORT",
              submitter: submitter,
            },
          },
          "*"
        );
      } else {
        alert("Invalid JSON");
      }
    } else if (submitter === "CSV") {
      if (isValidCSV(body)) {
        parent.postMessage(
          {
            pluginMessage: {
              body,
              type: "IMPORT",
              submitter: submitter,
            },
          },
          "*"
        );
      } else {
        alert("Invalid CSV");
      }
    }
  });

  function isValidJSON(body) {
    try {
      JSON.parse(body);
      return true;
    } catch (e) {
      return false;
    }
  }

  function isValidCSV(body) {
    try {
      let csv = body.split("\n");
      let headers = csv[0].split(",");
      let rows = csv.slice(1);
      if (headers.length < 2) {
        return false;
      }
      for (let i = 0; i < rows.length; i++) {
        let row = rows[i].split(",");
        if (row.length !== headers.length) {
          return false;
        }
      }
      return true;
    } catch (e) {
      console.log(e);
      return false;
    }
  }
</script>
